<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MCBE UI Master Editor</title>
    <style>
        :root {
            --bg-dark: #1e1e1e;
            --panel-bg: #252526;
            --border: #3e3e42;
            --accent: #3794ff;
            --accent-hover: #2a75cc;
            --text-main: #f0f0f0;
            --text-muted: #aaaaaa;
            --input-bg: #3c3c3c;
            --danger: #d94444;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Segoe UI', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header & Toolbar --- */
        header {
            height: 55px;
            background-color: #333;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 15px;
            justify-content: space-between;
            z-index: 10;
        }

        .brand { font-weight: bold; font-size: 1.1em; display:flex; align-items:center; gap:10px; }
        .preset-selector {
            background: var(--input-bg);
            color: white;
            border: 1px solid #555;
            padding: 5px;
            border-radius: 4px;
            margin-left: 15px;
        }

        .toolbar { display: flex; gap: 8px; }
        .btn {
            background-color: #444;
            color: white;
            border: 1px solid #555;
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
            transition: 0.2s;
            white-space: nowrap;
        }
        .btn:hover { background-color: #555; }
        .btn-primary { background-color: var(--accent); border-color: var(--accent-hover); }
        .btn-primary:hover { background-color: var(--accent-hover); }

        /* --- Layout --- */
        .main-container { display: flex; flex: 1; overflow: hidden; position: relative; }

        /* --- Sidebar (Assets) --- */
        .sidebar-left {
            width: 220px;
            background-color: var(--panel-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        /* --- Sidebar (Properties) --- */
        .sidebar-right {
            width: 300px;
            background-color: var(--panel-bg);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        /* --- Canvas Area --- */
        .workspace {
            flex: 1;
            background-color: #111;
            background-image: 
                linear-gradient(#222 1px, transparent 1px),
                linear-gradient(90deg, #222 1px, transparent 1px);
            background-size: 20px 20px;
            position: relative;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        #ui-preview {
            width: 854px; /* 480p scale usually used in MC logic */
            height: 480px;
            background-color: rgba(0,0,0,0.2);
            border: 2px dashed #444;
            position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* --- Components --- */
        .panel-title {
            padding: 10px 15px;
            background: #2d2d30;
            font-weight: 600;
            font-size: 0.9em;
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .asset-list { overflow-y: auto; padding: 10px; flex: 1; }
        .asset-item {
            display: flex; align-items: center; padding: 10px;
            background: #333; margin-bottom: 6px; border-radius: 4px;
            cursor: grab; border: 1px solid #444; transition: 0.2s;
        }
        .asset-item:hover { background: #3e3e42; border-color: #666; }
        .asset-icon {
            width: 24px; height: 24px; background: #555; margin-right: 10px;
            border-radius: 3px; display: flex; justify-content: center; align-items: center;
            font-size: 10px; font-weight: bold;
        }

        /* --- Form Elements --- */
        .prop-section { padding: 15px; border-bottom: 1px solid #333; }
        .prop-group { margin-bottom: 12px; }
        .prop-label { display: block; font-size: 0.85em; color: var(--text-muted); margin-bottom: 5px; }
        .prop-input, .prop-select {
            width: 100%; background: var(--input-bg); border: 1px solid #555;
            color: white; padding: 8px; border-radius: 3px; font-size: 0.9em;
        }
        .prop-input:focus { border-color: var(--accent); }
        .prop-row { display: flex; gap: 8px; }
        
        .hint-text { font-size: 0.75em; color: #888; margin-top: 3px; }

        /* --- UI Nodes on Canvas --- */
        .ui-node {
            position: absolute;
            box-sizing: border-box;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; overflow: hidden; user-select: none;
            font-size: 12px; color: #fff;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .ui-node.selected {
            outline: 2px solid var(--accent);
            z-index: 1000;
            box-shadow: 0 0 10px rgba(55, 148, 255, 0.3);
        }
        
        /* Specific Styles based on MC types */
        .type-button { background: #c6c6c6; color: #111; border: 2px solid #000; box-shadow: inset 2px 2px #fff, inset -2px -2px #555; }
        .type-label { background: transparent; border: 1px dashed rgba(255,255,255,0.4); text-shadow: 1px 1px 0 #000; }
        .type-image { background: #4a4a4a; display: flex; justify-content: center; align-items: center; color: #aaa; }
        .type-panel { background: rgba(0,0,0,0.5); border: 1px solid #000; }
        .type-input { background: #000; border: 1px solid #888; color: #fff; justify-content: flex-start; padding-left: 5px;}

        /* Resize Handles */
        .handle {
            width: 12px; height: 12px; background: var(--accent);
            position: absolute; display: none; border-radius: 50%;
        }
        .selected .handle { display: block; }
        .h-se { bottom: -6px; right: -6px; cursor: se-resize; }

        /* --- Mobile Responsive --- */
        .mobile-toggle { display: none; }
        
        @media (max-width: 850px) {
            .main-container { flex-direction: column; }
            header { flex-wrap: wrap; height: auto; padding: 10px; }
            .brand { width: 100%; margin-bottom: 10px; }
            .toolbar { width: 100%; justify-content: space-between; }
            
            .sidebar-left { 
                width: 100%; height: auto; flex-direction: row; 
                overflow-x: auto; border-bottom: 1px solid var(--border); padding: 5px;
            }
            .panel-title { display: none; }
            .asset-list { display: flex; flex-direction: row; gap: 10px; padding: 5px; }
            .asset-item { min-width: 110px; margin: 0; flex-direction: column; text-align: center;}
            .asset-icon { margin: 0 0 5px 0; }

            .sidebar-right {
                position: fixed; bottom: 0; left: 0; width: 100%; height: 60vh;
                z-index: 2000; border-top: 2px solid var(--accent);
                transform: translateY(100%);
            }
            .sidebar-right.open { transform: translateY(0); }
            
            .mobile-toggle {
                display: flex; position: fixed; bottom: 10px; right: 10px;
                background: var(--accent); color: white; width: 50px; height: 50px;
                border-radius: 50%; justify-content: center; align-items: center;
                box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 2001; font-size: 24px; cursor: pointer;
            }
            
            #ui-preview { transform: scale(0.6); transform-origin: top left; margin-bottom: 100px; }
        }
    </style>
</head>
<body>

<datalist id="mc-bindings">
    <option value="button.menu_exit">Êàª„Çã/Èñâ„Åò„Çã (menu_exit)</option>
    <option value="button.menu_ok">Ê±∫ÂÆö (menu_ok)</option>
    <option value="button.menu_cancel">„Ç≠„É£„É≥„Çª„É´ (menu_cancel)</option>
    <option value="button.chat">„ÉÅ„É£„ÉÉ„Éà„ÇíÈñã„Åè (chat)</option>
    <option value="button.slot_1">„Çπ„É≠„ÉÉ„Éà1 (slot_1)</option>
    <option value="button.slot_2">„Çπ„É≠„ÉÉ„Éà2 (slot_2)</option>
</datalist>

<datalist id="mc-collections">
    <option value="menu_button_template_handler">„É°„Éã„É•„Éº„Éú„Çø„É≥Âü∫Êú¨ (template_handler)</option>
    <option value="lock_button_collection">„É≠„ÉÉ„ÇØ„Éú„Çø„É≥ (lock_collection)</option>
    <option value="checkbox_collection">„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ (checkbox)</option>
</datalist>

<header>
    <div class="brand">
        <span>MCBE UI Studio</span>
        <select id="presetSelect" class="preset-selector" onchange="loadPreset(this.value)">
            <option value="" disabled selected>Load Preset...</option>
            <option value="title">Title Screen</option>
            <option value="pause">Pause Screen</option>
            <option value="hud">HUD (Play Screen)</option>
            <option value="chat">Chat Screen</option>
            <option value="inventory">Inventory</option>
            <option value="settings">Settings</option>
        </select>
    </div>
    <div class="toolbar">
        <button class="btn" onclick="document.getElementById('fileIn').click()">üìÇ Open</button>
        <button class="btn" onclick="document.getElementById('mergeIn').click()">‚ûï Merge</button>
        <button class="btn btn-primary" onclick="exportJson()">üíæ Export JSON</button>
    </div>
    <input type="file" id="fileIn" hidden accept=".json">
    <input type="file" id="mergeIn" hidden accept=".json">
</header>

<div class="main-container">
    <div class="sidebar-left">
        <div class="panel-title">Basic Controls</div>
        <div class="asset-list" id="assetList">
            <div class="asset-item" draggable="true" ondragstart="dragStart(event)" data-type="button">
                <div class="asset-icon" style="background:#888">BTN</div> Button
            </div>
            <div class="asset-item" draggable="true" ondragstart="dragStart(event)" data-type="label">
                <div class="asset-icon" style="border:1px dashed #fff; background:transparent">TXT</div> Label
            </div>
            <div class="asset-item" draggable="true" ondragstart="dragStart(event)" data-type="image">
                <div class="asset-icon" style="background:#556">IMG</div> Image
            </div>
            <div class="asset-item" draggable="true" ondragstart="dragStart(event)" data-type="panel">
                <div class="asset-icon" style="background:#222; border:1px solid #666">PNL</div> Panel
            </div>
            <div class="asset-item" draggable="true" ondragstart="dragStart(event)" data-type="input">
                <div class="asset-icon" style="background:#000; border:1px solid #888">INP</div> Input
            </div>
        </div>
    </div>

    <div class="workspace" id="workspace" ondrop="drop(event)" ondragover="allowDrop(event)">
        <div id="ui-preview">
            </div>
    </div>

    <div class="sidebar-right" id="propPanel">
        <div style="padding:10px; display:flex; justify-content:flex-end;">
            <button class="btn" onclick="toggleProps()" style="padding:2px 8px;">‚ñº Close</button>
        </div>
        
        <div class="panel-title">Global Settings</div>
        <div class="prop-section">
            <div class="prop-group">
                <label class="prop-label">Namespace</label>
                <input type="text" class="prop-input" id="globalNs" value="custom_ui">
            </div>
        </div>

        <div class="panel-title">Selected Element</div>
        <div id="element-props" style="display:none;">
            
            <div class="prop-section">
                <div class="prop-group">
                    <label class="prop-label">Element Key (ID) <span style="color:red">*</span></label>
                    <input type="text" class="prop-input" id="p-key" onchange="updateSelected()">
                </div>
                <div class="prop-group">
                    <div class="prop-row">
                        <div><label class="prop-label">X</label><input type="number" class="prop-input" id="p-x" onchange="updateSelected()"></div>
                        <div><label class="prop-label">Y</label><input type="number" class="prop-input" id="p-y" onchange="updateSelected()"></div>
                        <div><label class="prop-label">W</label><input type="number" class="prop-input" id="p-w" onchange="updateSelected()"></div>
                        <div><label class="prop-label">H</label><input type="number" class="prop-input" id="p-h" onchange="updateSelected()"></div>
                    </div>
                </div>
                <div class="prop-group">
                    <label class="prop-label">Anchor</label>
                    <select class="prop-select" id="p-anchor" onchange="updateSelected()">
                        <option value="top_left">Top Left</option>
                        <option value="top_middle">Top Middle</option>
                        <option value="top_right">Top Right</option>
                        <option value="center">Center</option>
                        <option value="bottom_left">Bottom Left</option>
                        <option value="bottom_middle">Bottom Middle</option>
                        <option value="bottom_right">Bottom Right</option>
                    </select>
                </div>
            </div>

            <div class="prop-section">
                <div class="prop-group">
                    <label class="prop-label">Text</label>
                    <input type="text" class="prop-input" id="p-text" onchange="updateSelected()">
                </div>
                <div class="prop-group">
                    <label class="prop-label">Texture Path</label>
                    <input type="text" class="prop-input" id="p-texture" placeholder="textures/ui/..." onchange="updateSelected()">
                </div>
            </div>

            <div class="prop-section">
                <label class="prop-label" style="color:var(--accent);">‚ö° Logic / Bindings</label>
                
                <div class="prop-group">
                    <label class="prop-label">Mapping Collection</label>
                    <input type="text" class="prop-input" id="p-collection" list="mc-collections" placeholder="e.g. global_options" onchange="updateSelected()">
                    <div class="hint-text">Select or type mapping logic</div>
                </div>

                <div class="prop-group">
                    <label class="prop-label">Button Binding (Trigger)</label>
                    <input type="text" class="prop-input" id="p-binding" list="mc-bindings" placeholder="e.g. button.menu_exit" onchange="updateSelected()">
                    <div class="hint-text">Action to trigger on press</div>
                </div>
            </div>

            <div class="prop-section">
                <button class="btn" style="width:100%; background:var(--danger); border-color:#b33;" onclick="deleteSelected()">Delete Element</button>
            </div>
        </div>
        
        <div id="no-selection" style="padding:30px; text-align:center; color:#666;">
            Select an element to edit properties.
        </div>
    </div>
    
    <div class="mobile-toggle" onclick="toggleProps()">‚úèÔ∏è</div>
</div>

<script>
    // --- State Management ---
    let appState = {
        namespace: "custom_ui",
        elements: [] 
    };
    let selectedId = null;
    let uniqueCounter = 0;

    // --- DOM References ---
    const canvas = document.getElementById('ui-preview');
    const globalNsInput = document.getElementById('globalNs');
    const propPanel = document.getElementById('propPanel');

    // --- Initialize ---
    globalNsInput.addEventListener('input', (e) => appState.namespace = e.target.value);

    // --- Presets (Templates) ---
    const PRESETS = {
        pause: { ns: "pause_screen", controls: [
            { type: "panel", key: "bg_panel", x: 200, y: 100, w: 454, h: 280, text: "", color: "rgba(0,0,0,0.5)" },
            { type: "label", key: "title_label", x: 380, y: 120, w: 100, h: 20, text: "GAME PAUSED", anchor: "top_middle" },
            { type: "button", key: "resume_btn", x: 327, y: 160, w: 200, h: 40, text: "Resume Game", binding: "button.menu_cancel" },
            { type: "button", key: "settings_btn", x: 327, y: 210, w: 200, h: 40, text: "Settings" },
            { type: "button", key: "quit_btn", x: 327, y: 260, w: 200, h: 40, text: "Save & Quit", binding: "button.menu_exit" }
        ]},
        hud: { ns: "hud_screen", controls: [
            { type: "image", key: "hotbar_bg", x: 227, y: 430, w: 400, h: 40, text: "", texture: "textures/ui/hotbar_bg" },
            { type: "label", key: "xp_text", x: 420, y: 400, w: 30, h: 10, text: "5", color: "#80ff00" }
        ]},
        title: { ns: "start_screen", controls: [
            { type: "image", key: "logo", x: 227, y: 30, w: 400, h: 100, text: "MINECRAFT", texture: "textures/ui/title" },
            { type: "button", key: "play_btn", x: 327, y: 200, w: 200, h: 40, text: "Play", collection: "menu_button_template_handler" }
        ]}
    };

    function loadPreset(type) {
        if (!confirm("This will clear current work. Continue?")) return;
        const preset = PRESETS[type];
        if (!preset) {
            alert("This preset is not yet implemented fully, loading default empty.");
            appState.namespace = type + "_screen";
            appState.elements = [];
        } else {
            appState.namespace = preset.ns;
            appState.elements = []; // Clear
            preset.controls.forEach(c => {
                // Generate ID and push
                addControlToState(c.type, c.x, c.y, c.w, c.h, c);
            });
        }
        globalNsInput.value = appState.namespace;
        renderAll();
    }

    // --- Core Logic: Add/Remove/Render ---

    function addControlToState(type, x, y, w, h, props = {}) {
        uniqueCounter++;
        const id = `el_${uniqueCounter}`;
        const autoKey = props.key || `${type}_${uniqueCounter}`;
        
        // Defaults based on type
        if(type === 'button') { if(!w) w=120; if(!h) h=30; if(!props.text) props.text="Button"; }
        if(type === 'panel') { if(!w) w=100; if(!h) h=100; }
        if(type === 'image') { if(!w) w=64; if(!h) h=64; }
        
        const newEl = {
            id: id,
            key: autoKey,
            type: type,
            x: Math.round(x),
            y: Math.round(y),
            w: Math.round(w),
            h: Math.round(h),
            text: props.text || "",
            texture: props.texture || "",
            anchor: props.anchor || "top_left",
            collection: props.collection || "",
            binding: props.binding || ""
        };
        appState.elements.push(newEl);
        return newEl;
    }

    function renderAll() {
        canvas.innerHTML = '';
        appState.elements.forEach(elData => {
            const el = document.createElement('div');
            el.className = `ui-node type-${elData.type}`;
            el.id = elData.id;
            
            // Content
            const span = document.createElement('span');
            span.style.pointerEvents="none";
            span.innerText = elData.text || (elData.type === 'image' ? (elData.texture ? '' : 'IMG') : '');
            el.appendChild(span);

            // Resize Handle
            const handle = document.createElement('div');
            handle.className = 'handle h-se';
            el.appendChild(handle);

            // Positioning
            updateDOM(el, elData);

            // Events
            el.addEventListener('mousedown', (e) => onMouseDown(e, elData.id));
            el.addEventListener('touchstart', (e) => onTouchStart(e, elData.id), {passive:false});

            canvas.appendChild(el);
        });
        // Deselect if cleared
        selectElement(null);
    }

    function updateDOM(el, data) {
        el.style.left = data.x + 'px';
        el.style.top = data.y + 'px';
        el.style.width = data.w + 'px';
        el.style.height = data.h + 'px';

        // Texture preview (Fake)
        if(data.texture) {
            el.style.backgroundImage = `repeating-linear-gradient(45deg, #606dbc 0, #606dbc 10px, #465298 10px, #465298 20px)`;
            el.title = data.texture;
        } else {
            el.style.backgroundImage = '';
        }
    }

    // --- Drag & Drop (Creation) ---
    function allowDrop(ev) { ev.preventDefault(); }
    function dragStart(ev) {
        ev.dataTransfer.setData("type", ev.target.dataset.type);
        ev.dataTransfer.setData("mode", "create");
    }
    function drop(ev) {
        ev.preventDefault();
        const mode = ev.dataTransfer.getData("mode");
        if(mode === "create") {
            const type = ev.dataTransfer.getData("type");
            const rect = canvas.getBoundingClientRect();
            // Scale correction for visual
            let scale = 1;
            if(window.innerWidth < 850) scale = 0.6;
            
            const x = (ev.clientX - rect.left) / scale;
            const y = (ev.clientY - rect.top) / scale;
            
            addControlToState(type, x, y, 0, 0);
            renderAll();
            // Select the last added
            const last = appState.elements[appState.elements.length-1];
            selectElement(last.id);
        }
    }

    // --- Selection & Properties ---
    function selectElement(id) {
        selectedId = id;
        document.querySelectorAll('.ui-node').forEach(n => n.classList.remove('selected'));
        
        const propsDiv = document.getElementById('element-props');
        const emptyDiv = document.getElementById('no-selection');

        if(id) {
            const el = document.getElementById(id);
            if(el) el.classList.add('selected');
            
            const data = appState.elements.find(e => e.id === id);
            
            // Populate Inputs
            document.getElementById('p-key').value = data.key;
            document.getElementById('p-x').value = data.x;
            document.getElementById('p-y').value = data.y;
            document.getElementById('p-w').value = data.w;
            document.getElementById('p-h').value = data.h;
            document.getElementById('p-text').value = data.text;
            document.getElementById('p-texture').value = data.texture;
            document.getElementById('p-anchor').value = data.anchor;
            document.getElementById('p-collection').value = data.collection;
            document.getElementById('p-binding').value = data.binding;

            propsDiv.style.display = 'block';
            emptyDiv.style.display = 'none';

            // Mobile Auto-Open
            if(window.innerWidth < 850) propPanel.classList.add('open');

        } else {
            propsDiv.style.display = 'none';
            emptyDiv.style.display = 'block';
            if(window.innerWidth < 850) propPanel.classList.remove('open');
        }
    }

    function updateSelected() {
        if(!selectedId) return;
        const data = appState.elements.find(e => e.id === selectedId);
        
        data.key = document.getElementById('p-key').value;
        data.x = parseInt(document.getElementById('p-x').value) || 0;
        data.y = parseInt(document.getElementById('p-y').value) || 0;
        data.w = parseInt(document.getElementById('p-w').value) || 10;
        data.h = parseInt(document.getElementById('p-h').value) || 10;
        data.text = document.getElementById('p-text').value;
        data.texture = document.getElementById('p-texture').value;
        data.anchor = document.getElementById('p-anchor').value;
        data.collection = document.getElementById('p-collection').value;
        data.binding = document.getElementById('p-binding').value;

        // Re-render specifically this element's text/style
        const el = document.getElementById(selectedId);
        const span = el.querySelector('span');
        if(span) span.innerText = data.text || (data.type==='image'?'':(data.texture?'':'IMG'));
        updateDOM(el, data);
    }

    function deleteSelected() {
        if(!selectedId) return;
        appState.elements = appState.elements.filter(e => e.id !== selectedId);
        renderAll();
    }

    // --- Interaction (Move/Resize) ---
    let interactState = { active: false, type: '', startX: 0, startY: 0, initial: {} };

    function onMouseDown(e, id) {
        if(e.button !== 0) return;
        e.stopPropagation();
        startInteraction(e.clientX, e.clientY, e.target.classList.contains('handle') ? 'resize' : 'move', id);
    }
    
    function onTouchStart(e, id) {
        e.preventDefault();
        e.stopPropagation();
        startInteraction(e.touches[0].clientX, e.touches[0].clientY, e.target.classList.contains('handle') ? 'resize' : 'move', id);
    }

    function startInteraction(cx, cy, type, id) {
        selectElement(id);
        const data = appState.elements.find(e => e.id === id);
        interactState = {
            active: true,
            type: type,
            startX: cx,
            startY: cy,
            initial: { ...data }
        };
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', endInteraction);
        document.addEventListener('touchmove', onTouchMove, {passive:false});
        document.addEventListener('touchend', endInteraction);
    }

    function onMove(e) { handleMove(e.clientX, e.clientY); }
    function onTouchMove(e) { e.preventDefault(); handleMove(e.touches[0].clientX, e.touches[0].clientY); }

    function handleMove(cx, cy) {
        if(!interactState.active) return;
        
        // Scale correction
        let scale = 1;
        if(window.innerWidth < 850) scale = 0.6;

        const dx = (cx - interactState.startX) / scale;
        const dy = (cy - interactState.startY) / scale;

        const data = appState.elements.find(e => e.id === selectedId);

        if(interactState.type === 'move') {
            data.x = Math.round(interactState.initial.x + dx);
            data.y = Math.round(interactState.initial.y + dy);
        } else {
            data.w = Math.max(10, Math.round(interactState.initial.w + dx));
            data.h = Math.max(10, Math.round(interactState.initial.h + dy));
        }
        
        // Update DOM & Inputs
        updateDOM(document.getElementById(selectedId), data);
        document.getElementById('p-x').value = data.x;
        document.getElementById('p-y').value = data.y;
        document.getElementById('p-w').value = data.w;
        document.getElementById('p-h').value = data.h;
    }

    function endInteraction() {
        interactState.active = false;
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', endInteraction);
        document.removeEventListener('touchmove', onTouchMove);
        document.removeEventListener('touchend', endInteraction);
    }

    // --- File IO ---
    document.getElementById('fileIn').addEventListener('change', (e) => processFile(e.target.files[0], false));
    document.getElementById('mergeIn').addEventListener('change', (e) => processFile(e.target.files[0], true));

    function processFile(file, isMerge) {
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                if(isMerge) mergeAssets(json, file.name);
                else parseMainJson(json);
            } catch(err) { alert("Invalid JSON: " + err); }
        };
        reader.readAsText(file);
    }

    function parseMainJson(json) {
        appState.elements = [];
        appState.namespace = json.namespace || "imported_ui";
        globalNsInput.value = appState.namespace;
        
        // Flatten logic
        for (const [key, val] of Object.entries(json)) {
            if(key === 'namespace') continue;
            if(val && val.type) {
                // Extract logic
                let collection = "";
                let binding = "";
                
                // Try to find collection in properites (simplified)
                if(val.bindings && val.bindings.length > 0) {
                     binding = val.bindings[0].binding_name || "";
                }
                
                // Add to canvas
                addControlToState(val.type, val.offset?val.offset[0]:0, val.offset?val.offset[1]:0, val.size?val.size[0]:50, val.size?val.size[1]:20, {
                    key: key,
                    text: val.text || "",
                    texture: val.texture || "",
                    anchor: val.anchor_from || "top_left",
                    binding: binding
                });
            }
        }
        renderAll();
    }

    function mergeAssets(json, filename) {
        const list = document.getElementById('assetList');
        const header = document.createElement('div');
        header.style.color = '#888'; header.style.fontSize='0.8em'; header.style.padding='5px';
        header.innerText = `--- ${filename} ---`;
        list.appendChild(header);

        for (const [key, val] of Object.entries(json)) {
            if(val && val.type) {
                const div = document.createElement('div');
                div.className = 'asset-item';
                div.draggable = true;
                div.innerHTML = `<div class="asset-icon" style="background:#d80">Copy</div> ${key}`;
                div.onclick = () => {
                     addControlToState(val.type, 50, 50, val.size?val.size[0]:100, val.size?val.size[1]:30, { 
                         key: key+"_copy", text: val.text, texture: val.texture 
                     });
                     renderAll();
                };
                list.appendChild(div);
            }
        }
    }

    function exportJson() {
        const out = { namespace: appState.namespace };
        appState.elements.forEach(el => {
            const obj = {
                type: el.type,
                offset: [el.x, el.y],
                size: [el.w, el.h],
                layer: 1
            };
            if(el.anchor !== "top_left") { obj.anchor_from = el.anchor; obj.anchor_to = el.anchor; }
            if(el.text) obj.text = el.text;
            if(el.texture) obj.texture = el.texture;
            
            // Logic Export
            if(el.collection) obj.mapping_collection_name = el.collection;
            if(el.binding) {
                obj.bindings = [
                    {
                        binding_type: "global", // Default assumption
                        binding_name: el.binding,
                        binding_name_override: el.binding
                    }
                ];
            }
            out[el.key] = obj;
        });
        
        const blob = new Blob([JSON.stringify(out, null, 2)], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${appState.namespace}.json`;
        a.click();
    }

    function toggleProps() {
        propPanel.classList.toggle('open');
    }
</script>
</body>
</html>
