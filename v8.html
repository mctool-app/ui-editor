<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MCBE UI Studio: Authentic Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #1e1e1e;
            --panel-bg: #252526;
            --header-bg: #333333;
            --border: #474747;
            --mc-font: 'VT323', monospace;
            --nav-height: 60px;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; background-color: var(--bg-dark); color: #e0e0e0;
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            font-family: 'Segoe UI', sans-serif;
        }

        /* --- Header --- */
        header {
            height: 50px; background-color: var(--header-bg); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 0 15px; justify-content: space-between; flex-shrink: 0; z-index: 100;
        }
        .brand { font-family: var(--mc-font); font-size: 1.5em; text-shadow: 2px 2px 0 #000; letter-spacing: 1px; }
        .toolbar { display: flex; gap: 8px; }

        .btn {
            background: #3c3c3c; color: #fff; border: 2px solid #222;
            padding: 4px 12px; cursor: pointer; font-family: var(--mc-font); font-size: 1.2em; 
            text-shadow: 1px 1px 0 #000; display: inline-flex; align-items: center; gap: 6px;
            box-shadow: inset 2px 2px 0 rgba(255,255,255,0.1), inset -2px -2px 0 rgba(0,0,0,0.3);
        }
        .btn:hover { background: #4c4c4c; }
        .btn:active { transform: translateY(1px); box-shadow: inset 2px 2px 0 rgba(0,0,0,0.3); }
        .btn-primary { color: #ffffaa; border-color: #554400; background: #555; }
        
        /* --- Layout --- */
        .workspace-container { display: flex; flex: 1; overflow: hidden; position: relative; }

        .sidebar {
            width: 280px; background: var(--panel-bg); display: flex; flex-direction: column;
            border-right: 1px solid var(--border); z-index: 50;
        }
        .sidebar.right { border-left: 1px solid var(--border); border-right: none; }
        
        .sidebar-header {
            padding: 10px 15px; font-weight: bold; background: #2d2d2d; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; font-family: var(--mc-font); font-size: 1.3em;
        }

        /* --- Canvas (16:9 Viewport) --- */
        .canvas-wrapper {
            flex: 1; background: #111; position: relative; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            /* Authentic dirt background pattern for the void */
            background-color: #121212;
            background-image: radial-gradient(#2a2a2a 1px, transparent 1px);
            background-size: 20px 20px;
        }

        #screen-container {
            width: 854px; height: 480px; /* MCBE Standard Reference */
            position: relative;
            transform-origin: center center;
            box-shadow: 0 0 100px rgba(0,0,0,1);
            user-select: none;
            overflow: hidden; /* Clips elements outside screen */
            /* Default in-game UI background mostly transparent */
            background: rgba(0,0,0,0.0); 
        }
        
        /* The UI Grid Overlay */
        #screen-grid {
            position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none;
            background-image: 
                linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 42.7px 40px; /* Approx grid */
            opacity: 0.2; z-index: 0;
        }

        /* --- MINECRAFT AUTHENTIC UI STYLES --- */
        .ui-element {
            position: absolute; display: flex; justify-content: center; align-items: center;
            font-family: var(--mc-font); color: #fff; 
            cursor: pointer; z-index: 10; white-space: pre-wrap;
            box-sizing: border-box;
        }

        /* Selection Highlight (Animated Dashed) */
        .ui-element.selected {
            z-index: 1000;
        }
        .ui-element.selected::after {
            content: ''; position: absolute; top:-2px; left:-2px; right:-2px; bottom:-2px;
            border: 2px dashed #ffff00;
            animation: dash 1s linear infinite;
            pointer-events: none;
        }
        @keyframes dash { to { opacity: 0.5; } 50% { opacity: 1; } from { opacity: 0.5; } }

        /* 1. Button: The classic Stone Button look */
        .mc-button {
            background-color: #7e7e7e; /* Base grey */
            color: #e0e0e0;
            text-shadow: 2px 2px 0 #3e3e3e;
            font-size: 20px;
            /* The MC Bevel Effect */
            border: 2px solid #1e1e1e; /* Darkest outer */
            border-top-color: #c6c6c6; /* Lightest top */
            border-left-color: #c6c6c6;
            border-bottom-color: #1e1e1e; /* Darkest bottom */
            border-right-color: #1e1e1e;
            box-shadow: inset 2px 2px 0 #a2a2a2, inset -2px -2px 0 #545454;
        }
        /* Active state for button (pressed) */
        .mc-button:active {
            background-color: #5d5d5d;
        }

        /* 2. Label: Text with shadow */
        .mc-label {
            pointer-events: auto; font-size: 20px; text-align: left;
            text-shadow: 2px 2px 0 #3f3f3f;
            color: #ffffff;
            /* Allow clicking through transparent parts if needed, but for editor we need to click */
        }

        /* 3. Panel: Dark semi-transparent background with border */
        .mc-panel {
            background-color: rgba(30, 30, 30, 0.8);
            border: 2px solid #555;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        /* 4. Input: Dark field */
        .mc-input {
            background-color: #000;
            border: 2px solid #a0a0a0;
            border-bottom-color: #fff;
            border-right-color: #fff;
            color: #fff;
            justify-content: flex-start;
            padding-left: 8px;
            text-shadow: none;
        }
        .mc-input::after {
            content: '_'; animation: blink 1s step-end infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* 5. Image: Placeholder */
        .mc-image {
            background: rgba(255, 255, 255, 0.1);
            border: 1px dashed #777;
            color: #aaa;
            font-size: 14px; text-shadow: none;
        }

        /* --- Controls & Lists --- */
        .list-item {
            padding: 10px 15px; border-bottom: 1px solid #333; cursor: pointer; display: flex; align-items: center; gap: 10px;
        }
        .list-item:hover { background: #333; }
        .icon-box { width: 28px; height: 28px; background: #333; display: flex; align-items: center; justify-content: center; border: 2px solid #555; font-family: var(--mc-font); color: #fff;}
        
        .prop-group { padding: 12px 15px; border-bottom: 1px solid #333; }
        .prop-label { font-size: 0.8em; color: var(--text-mute); margin-bottom: 5px; display: block; }
        .prop-input { 
            width: 100%; background: #111; border: 1px solid #555; color: #fff; padding: 6px; 
            font-family: var(--mc-font); font-size: 1.1em;
        }
        .row { display: flex; gap: 5px; } .col { flex: 1; }

        /* --- Overlays --- */
        #loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85);
            z-index: 3000; display: none; justify-content: center; align-items: center; flex-direction: column;
            color: #fff; font-family: var(--mc-font); font-size: 2em;
        }

        /* Modals */
        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8);
            z-index: 2000; display: none; justify-content: center; align-items: center;
        }
        .modal {
            width: 600px; max-width: 90%; height: 80vh; background: #c6c6c6;
            border: 2px solid #fff; outline: 2px solid #000;
            display: flex; flex-direction: column; color: #000;
        }
        .modal-header { background: #8f8f8f; padding: 10px; font-weight: bold; font-family: var(--mc-font); font-size: 1.5em; border-bottom: 2px solid #555; display:flex; justify-content:space-between; }
        .file-list { flex: 1; overflow-y: auto; padding: 5px; background: #111; }
        .file-item { color: #fff; padding: 8px; border-bottom: 1px solid #333; font-family: var(--mc-font); cursor: pointer; font-size: 1.2em; }
        .file-item:hover { background: #333; color: #ffff55; }

        /* --- Mobile Responsiveness --- */
        .mobile-nav { display: none; }
        .close-drawer { display: none; }

        @media (max-width: 800px) {
            .workspace-container { flex-direction: column; }
            .toolbar .btn span { display: none; } 
            
            .sidebar {
                position: fixed; top: 0; bottom: var(--nav-height); width: 100%;
                z-index: 150; transform: translateY(110%);
                border: none;
            }
            .sidebar.active { transform: translateY(0); }
            .close-drawer { display: block; cursor: pointer; font-size: 1.5em; padding: 0 10px; }
            .mobile-nav {
                display: flex; height: var(--nav-height); background: #1a1a1a; border-top: 1px solid #333;
                position: fixed; bottom: 0; width: 100%; z-index: 200; justify-content: space-around;
            }
            .nav-item {
                flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
                color: #777; font-size: 0.75em; cursor: pointer;
            }
            .nav-item.active { color: #fff; }
            .nav-icon { font-size: 1.4em; margin-bottom: 2px; }
        }
    </style>
</head>
<body>

<datalist id="mc-bindings">
    <option value="button.menu_exit">Êàª„Çã (menu_exit)</option>
    <option value="button.menu_ok">Ê±∫ÂÆö (menu_ok)</option>
    <option value="button.chat">„ÉÅ„É£„ÉÉ„Éà (chat)</option>
</datalist>

<header>
    <div class="brand">MCBE UI Studio</div>
    <div class="toolbar">
        <button class="btn btn-primary" onclick="openGitHubBrowser()">‚òÅÔ∏è <span>Samples</span></button>
        <button class="btn" onclick="document.getElementById('fileIn').click()">üìÇ <span>Load</span></button>
        <button class="btn" onclick="document.getElementById('mergeIn').click()">‚ûï <span>Merge</span></button>
        <button class="btn" onclick="exportJson()">üíæ <span>Save</span></button>
    </div>
    <input type="file" id="fileIn" hidden accept=".json">
    <input type="file" id="mergeIn" hidden accept=".json">
</header>

<div class="workspace-container">
    <div class="sidebar" id="panel-assets">
        <div class="sidebar-header">ADD ELEMENT <span class="close-drawer" onclick="toggleMobileTab(null)">‚úï</span></div>
        <div style="overflow-y:auto; flex:1;">
            <div class="list-item" onclick="addElement('button')"><div class="icon-box">B</div> <div>Button Control</div></div>
            <div class="list-item" onclick="addElement('label')"><div class="icon-box">T</div> <div>Label Control</div></div>
            <div class="list-item" onclick="addElement('image')"><div class="icon-box">I</div> <div>Image Control</div></div>
            <div class="list-item" onclick="addElement('panel')"><div class="icon-box">P</div> <div>Panel Container</div></div>
            <div class="list-item" onclick="addElement('input')"><div class="icon-box">_</div> <div>Input Control</div></div>
        </div>
    </div>

    <div class="canvas-wrapper" id="canvas-wrapper">
        <div id="screen-container">
            <div id="screen-grid"></div>
            <div id="ui-layer"></div>
        </div>
    </div>

    <div class="sidebar right" id="panel-props">
        <div class="sidebar-header">PROPERTIES <span class="close-drawer" onclick="toggleMobileTab(null)">‚úï</span></div>
        <div id="prop-content" style="overflow-y:auto; flex:1; display:none;">
            <div class="prop-group">
                <label class="prop-label">Element Key (ID)</label>
                <input type="text" class="prop-input" id="p-key" onchange="updateEl()">
            </div>
            <div class="prop-group">
                <label class="prop-label">Anchor (Origin)</label>
                <select class="prop-input" id="p-anchor" onchange="updateEl()">
                    <option value="top_left">Top Left</option>
                    <option value="top_middle">Top Middle</option>
                    <option value="top_right">Top Right</option>
                    <option value="left_middle">Left Middle</option>
                    <option value="center">Center</option>
                    <option value="right_middle">Right Middle</option>
                    <option value="bottom_left">Bottom Left</option>
                    <option value="bottom_middle">Bottom Middle</option>
                    <option value="bottom_right">Bottom Right</option>
                </select>
            </div>
            <div class="prop-group">
                <label class="prop-label">Offset (px)</label>
                <div class="row">
                    <div class="col"><input type="number" class="prop-input" id="p-x" onchange="updateEl()" placeholder="X"></div>
                    <div class="col"><input type="number" class="prop-input" id="p-y" onchange="updateEl()" placeholder="Y"></div>
                </div>
            </div>
            <div class="prop-group">
                <label class="prop-label">Size (px or %)</label>
                <div class="row">
                    <div class="col"><input type="text" class="prop-input" id="p-w" onchange="updateEl()" placeholder="Width"></div>
                    <div class="col"><input type="text" class="prop-input" id="p-h" onchange="updateEl()" placeholder="Height"></div>
                </div>
            </div>
            <div class="prop-group">
                <label class="prop-label">Text / Content</label>
                <input type="text" class="prop-input" id="p-text" placeholder="Text..." onchange="updateEl()">
                <input type="text" class="prop-input" id="p-texture" placeholder="textures/ui/..." style="margin-top:5px;" onchange="updateEl()">
            </div>
            <div class="prop-group">
                <label class="prop-label">Binding</label>
                <input type="text" class="prop-input" id="p-bind" list="mc-bindings" placeholder="button.close" onchange="updateEl()">
            </div>
            <div class="prop-group">
                <button class="btn" style="width:100%; background:#800; border-color:#500;" onclick="deleteEl()">Delete Element</button>
            </div>
        </div>
        <div id="no-sel" style="padding:20px; text-align:center; color:#666; font-family:var(--mc-font);">Select an element to edit</div>
    </div>
</div>

<div class="mobile-nav">
    <div class="nav-item" onclick="toggleMobileTab('panel-assets')"><div class="nav-icon">Ôºã</div><div>Add</div></div>
    <div class="nav-item" onclick="toggleMobileTab('panel-props')"><div class="nav-icon">‚úé</div><div>Edit</div></div>
    <div class="nav-item" onclick="document.querySelector('.toolbar').scrollIntoView({behavior:'smooth'});"><div class="nav-icon">‚¨Ü</div><div>Menu</div></div>
</div>

<div class="modal-overlay" id="ghModal" onclick="if(event.target===this) closeGhModal()">
    <div class="modal">
        <div class="modal-header">Bedrock UI Samples <button class="btn" style="background:#800;" onclick="closeGhModal()">X</button></div>
        <div class="file-list" id="ghFileList"><div style="text-align:center; padding:20px; color:#fff;">Loading...</div></div>
    </div>
</div>

<div id="loading-overlay">
    <div>Processing...</div>
</div>

<script>
    // --- Application Core ---
    const app = { ns: "custom_ui", elements: [], zoom: 1 };
    let selectedId = null;
    let uid = 0;

    // --- Initialization ---
    window.addEventListener('resize', fitScreen);
    setTimeout(fitScreen, 100);

    function fitScreen() {
        const wrapper = document.getElementById('canvas-wrapper');
        const container = document.getElementById('screen-container');
        // Subtract padding/UI
        const pad = 40;
        const w = wrapper.offsetWidth - pad;
        const h = wrapper.offsetHeight - pad;
        
        // Target: 854x480 (16:9 standard UI reference)
        const scaleW = w / 854;
        const scaleH = h / 480;
        
        app.zoom = Math.min(scaleW, scaleH, 1.2); 
        container.style.transform = `scale(${app.zoom})`;
    }

    function toggleMobileTab(id) {
        document.querySelectorAll('.sidebar').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        if(id) {
            document.getElementById(id).classList.add('active');
            if(id === 'panel-assets') document.querySelectorAll('.nav-item')[0].classList.add('active');
            if(id === 'panel-props') document.querySelectorAll('.nav-item')[1].classList.add('active');
        }
    }

    // --- Enhanced JSON Sanitizer ---
    function cleanJson(text) {
        // Remove BOM
        if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
        
        // Remove comments
        text = text.replace(/\/\*[\s\S]*?\*\//g, ""); 
        text = text.replace(/([^:]|^)\/\/[^\n]*/g, '$1');

        // Remove Bad Control Characters (Fixes "Error at position X")
        text = text.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F]/g, "");

        // Fix unescaped newlines in strings
        text = text.replace(/"((?:[^"\\]|\\.)*)"/g, function(match, inner) {
            if (/[\n\t\r]/.test(inner)) {
                return '"' + inner.replace(/\n/g, "\\n").replace(/\t/g, "\\t").replace(/\r/g, "") + '"';
            }
            return match;
        });

        // Trailing commas
        text = text.replace(/,(\s*[}\]])/g, '$1');
        return text;
    }

    // --- Loading & Import ---
    function showLoading(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }

    async function openGitHubBrowser() {
        const modal = document.getElementById('ghModal');
        const list = document.getElementById('ghFileList');
        modal.style.display = 'flex';
        list.innerHTML = '<div style="text-align:center; padding:20px;">Fetching...</div>';

        try {
            const resp = await fetch('https://api.github.com/repos/Mojang/bedrock-samples/contents/resource_pack/ui');
            if(!resp.ok) throw new Error("GitHub API Limit");
            const files = await resp.json();
            list.innerHTML = '';
            files.filter(f => f.name.endsWith('.json')).sort((a,b) => a.name.localeCompare(b.name)).forEach(f => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerText = f.name;
                const cdnUrl = `https://cdn.jsdelivr.net/gh/Mojang/bedrock-samples@main/resource_pack/ui/${f.name}`;
                item.onclick = () => loadFromUrl(cdnUrl, f.name);
                list.appendChild(item);
            });
        } catch(e) { list.innerHTML = `<div style="color:#ff5555; text-align:center;">Error: ${e.message}</div>`; }
    }
    function closeGhModal() { document.getElementById('ghModal').style.display = 'none'; }

    async function loadFromUrl(url, fname) {
        if(!confirm(`Load ${fname}?`)) return;
        showLoading(true);
        try {
            const resp = await fetch(url);
            const txt = await resp.text();
            processImport(txt);
            closeGhModal();
            toggleMobileTab(null);
        } catch(e) { alert("Error: " + e.message); }
        finally { showLoading(false); }
    }

    document.getElementById('fileIn').onchange = (e) => readFile(e.target.files[0], false);
    document.getElementById('mergeIn').onchange = (e) => readFile(e.target.files[0], true);

    function readFile(file, isMerge) {
        if(!file) return;
        showLoading(true);
        const r = new FileReader();
        r.onload = e => { processImport(e.target.result, isMerge); showLoading(false); };
        r.readAsText(file);
    }

    function processImport(rawText, isMerge=false) {
        const cleaned = cleanJson(rawText);
        try {
            const json = JSON.parse(cleaned);
            parseJson(json, isMerge);
        } catch(e) {
            alert("JSON Error:\n" + e.message);
        }
    }

    // --- Parser with Size Fixes ---
    function parseJson(json, isMerge) {
        if(!isMerge) { app.elements = []; app.ns = json.namespace || "custom_ui"; selectedId = null; }
        
        for(let k in json) {
            if(k==='namespace') continue;
            const v = json[k];
            if(v.type) {
                uid++;
                // Smart Text Inference
                let txt = v.text || "";
                if(!txt && v.type==='button' && v.button_mappings) txt = "Button"; 
                if(!txt && v.type==='label') txt = "Label";

                // Size Parsing (Handle "100%" vs 100)
                let w = v.size?.[0] || (v.type === 'panel' ? "100%" : 50);
                let h = v.size?.[1] || (v.type === 'panel' ? "100%" : 20);
                
                // If button default size
                if(v.type === 'button' && (!v.size)) { w=120; h=30; }

                app.elements.push({
                    id: `el_${uid}`,
                    key: k + (isMerge?'_copy':''),
                    type: v.type,
                    anchor: v.anchor_from || "top_left",
                    x: v.offset?.[0]||0, y: v.offset?.[1]||0,
                    w: w, h: h,
                    text: txt,
                    texture: v.texture || "",
                    binding: ""
                });
            }
        }
        render();
    }

    // --- Rendering Logic (The Minecraft Engine) ---
    function getSize(val) {
        // If it's a number, add px. If it's a string with %, keep it. If variable ($), default to 50px.
        if (typeof val === 'number') return val + 'px';
        if (typeof val === 'string') {
            if (val.includes('%')) return val;
            if (val.startsWith('$')) return '50px'; // Variable fallback
            return parseInt(val) + 'px';
        }
        return 'auto';
    }

    function getCssPosition(el) {
        const styles = { 
            width: getSize(el.w), 
            height: getSize(el.h), 
            left: 'auto', right: 'auto', top: 'auto', bottom: 'auto', 
            transform: 'none' 
        };
        
        const x = el.x; const y = el.y;
        
        // Anchor Logic
        switch(el.anchor) {
            case 'top_left': styles.left = x + 'px'; styles.top = y + 'px'; break;
            case 'top_middle': styles.left = '50%'; styles.top = y + 'px'; styles.transform = `translateX(-50%) translateX(${x}px)`; break;
            case 'top_right': styles.right = (-x) + 'px'; styles.top = y + 'px'; break;
            case 'left_middle': styles.left = x + 'px'; styles.top = '50%'; styles.transform = `translateY(-50%) translateY(${y}px)`; break;
            case 'center': styles.left = '50%'; styles.top = '50%'; styles.transform = `translate(-50%, -50%) translate(${x}px, ${y}px)`; break;
            case 'right_middle': styles.right = (-x) + 'px'; styles.top = '50%'; styles.transform = `translateY(-50%) translateY(${y}px)`; break;
            case 'bottom_left': styles.left = x + 'px'; styles.bottom = (-y) + 'px'; break;
            case 'bottom_middle': styles.left = '50%'; styles.bottom = (-y) + 'px'; styles.transform = `translateX(-50%) translateX(${x}px)`; break;
            case 'bottom_right': styles.right = (-x) + 'px'; styles.bottom = (-y) + 'px'; break;
            default: styles.left = x + 'px'; styles.top = y + 'px';
        }
        return styles;
    }

    function render() {
        const layer = document.getElementById('ui-layer');
        layer.innerHTML = '';
        app.elements.forEach(el => {
            const div = document.createElement('div');
            div.className = `ui-element mc-${el.type}`;
            if(selectedId === el.id) div.classList.add('selected');
            Object.assign(div.style, getCssPosition(el));
            
            // Content
            if(el.type === 'button') div.innerText = el.text || "";
            if(el.type === 'label') div.innerText = el.text || el.key;
            if(el.type === 'input') div.innerText = el.text || "";
            if(el.type === 'image') div.innerText = el.texture ? "" : "IMG";
            
            // Interaction
            div.onmousedown = (e) => { e.stopPropagation(); selectElement(el.id); startDrag(e, el.id); };
            div.ontouchstart = (e) => { e.stopPropagation(); selectElement(el.id); startDrag(e.touches[0], el.id); };
            
            layer.appendChild(div);
        });
    }

    function selectElement(id) {
        selectedId = id; render();
        const el = app.elements.find(e => e.id === id);
        const panel = document.getElementById('prop-content');
        const none = document.getElementById('no-sel');
        
        if(el) {
            panel.style.display = 'block'; none.style.display = 'none';
            setVal('p-key', el.key);
            setVal('p-anchor', el.anchor);
            setVal('p-x', el.x); setVal('p-y', el.y);
            setVal('p-w', el.w); setVal('p-h', el.h);
            setVal('p-text', el.text);
            setVal('p-texture', el.texture);
            setVal('p-bind', el.binding);
        } else {
            panel.style.display = 'none'; none.style.display = 'block';
        }
    }

    // --- Dragging ---
    let drag = null;
    function startDrag(e, id) {
        const el = app.elements.find(x=>x.id===id);
        drag = { id, startX: e.clientX, startY: e.clientY, initX: el.x, initY: el.y };
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onEnd);
        document.addEventListener('touchmove', onTouchMove, {passive:false});
        document.addEventListener('touchend', onEnd);
    }
    function onMove(e) {
        if(!drag) return;
        const dx = (e.clientX - drag.startX) / app.zoom; 
        const dy = (e.clientY - drag.startY) / app.zoom;
        const el = app.elements.find(x=>x.id===drag.id);
        let modX = 1, modY = 1;
        // Invert drag logic for right/bottom anchors so it feels natural
        if(el.anchor.includes('right')) modX = -1; 
        if(el.anchor.includes('bottom')) modY = -1;
        
        el.x = Math.round(drag.initX + (dx * modX));
        el.y = Math.round(drag.initY + (dy * modY));
        render();
        if(selectedId === el.id) { setVal('p-x', el.x); setVal('p-y', el.y); }
    }
    function onTouchMove(e) { e.preventDefault(); onMove(e.touches[0]); }
    function onEnd() { 
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('touchmove', onTouchMove);
        drag = null; 
    }

    // --- Helpers ---
    function setVal(id, v) { document.getElementById(id).value = v !== undefined ? v : ''; }
    function getVal(id) { return document.getElementById(id).value; }
    
    function addElement(type) {
        uid++;
        let w = type==='button'?120 : (type==='panel'?'50%':50);
        let h = type==='button'?30 : (type==='panel'?'50%':20);
        
        app.elements.push({
            id: `el_${uid}`, key: `${type}_${uid}`, type,
            anchor: 'center', x: 0, y: 0, w: w, h: h,
            text: type==='label'?'New Text':(type==='button'?'Button':''), 
            texture: '', binding: ''
        });
        render(); selectElement(`el_${uid}`);
        if(window.innerWidth <= 800) toggleMobileTab('panel-props');
    }

    function updateEl() {
        if(!selectedId) return;
        const el = app.elements.find(e => e.id === selectedId);
        el.key = getVal('p-key'); el.anchor = getVal('p-anchor');
        el.x = parseInt(getVal('p-x'))||0; el.y = parseInt(getVal('p-y'))||0;
        
        // Handle numbers vs strings for W/H
        const rawW = getVal('p-w'); const rawH = getVal('p-h');
        el.w = rawW.includes('%') ? rawW : (parseInt(rawW)||10);
        el.h = rawH.includes('%') ? rawH : (parseInt(rawH)||10);

        el.text = getVal('p-text'); el.texture = getVal('p-texture');
        el.binding = getVal('p-bind');
        render();
    }

    function deleteEl() {
        if(selectedId && confirm('Delete this element?')) {
            app.elements = app.elements.filter(e => e.id !== selectedId);
            selectedId = null; render(); selectElement(null);
        }
    }

    function exportJson() {
        const out = { namespace: app.ns };
        app.elements.forEach(el => {
            out[el.key] = {
                type: el.type,
                anchor_from: el.anchor, anchor_to: el.anchor,
                offset: [el.x, el.y],
                size: [ typeof el.w === 'string' ? el.w : el.w, typeof el.h === 'string' ? el.h : el.h ],
                text: el.text, texture: el.texture
            };
            if(el.binding) out[el.key].bindings = [{ binding_type: "global", binding_name: el.binding }];
        });
        const blob = new Blob([JSON.stringify(out, null, 2)], {type:"application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${app.ns}.json`; a.click();
    }
</script>
</body>
</html>
