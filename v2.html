<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MCBE UI Ultimate Editor</title>
    <style>
        :root {
            --bg-dark: #1e1e1e;
            --panel-bg: #252526;
            --border: #3e3e42;
            --accent: #007fd4;
            --accent-hover: #0060a0;
            --text-main: #cccccc;
            --text-light: #ffffff;
            --input-bg: #3c3c3c;
            --danger: #d94444;
            --success: #48c774;
        }

        * { box-sizing: border-box; outline: none; font-family: 'Segoe UI', sans-serif; }
        
        body {
            margin: 0; background-color: var(--bg-dark); color: var(--text-main);
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- Header --- */
        header {
            height: 50px; background-color: #333; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 0 10px; justify-content: space-between;
        }
        .brand { font-weight: bold; color: var(--text-light); display:flex; gap:10px; align-items:center; }
        .toolbar { display: flex; gap: 5px; }

        .btn {
            background: #444; color: var(--text-light); border: 1px solid #555;
            padding: 5px 10px; cursor: pointer; border-radius: 2px; font-size: 0.85em;
        }
        .btn:hover { background: #555; }
        .btn-primary { background: var(--accent); border-color: var(--accent); }
        .btn-primary:hover { background: var(--accent-hover); }

        select.dark-select {
            background: var(--input-bg); color: white; border: 1px solid #555; padding: 4px;
        }

        /* --- Layout --- */
        .main-container { display: flex; flex: 1; overflow: hidden; }

        .sidebar-left { width: 220px; background: var(--panel-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-right { width: 320px; background: var(--panel-bg); border-left: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; }
        
        .workspace {
            flex: 1; background: #111; position: relative; overflow: auto;
            background-image: radial-gradient(#333 1px, transparent 1px); background-size: 20px 20px;
            display: flex; justify-content: center; align-items: center; padding: 40px;
        }

        #ui-preview {
            width: 854px; height: 480px; background: rgba(0,0,0,0.2);
            border: 2px dashed #444; position: relative; box-shadow: 0 0 30px #000;
        }

        /* --- Assets List --- */
        .panel-head { padding: 8px 10px; background: #2d2d30; font-weight: bold; font-size: 0.85em; border-bottom: 1px solid #333; color: #fff; }
        .asset-list { flex: 1; overflow-y: auto; padding: 5px; }
        .asset-item {
            display: flex; align-items: center; padding: 6px; margin-bottom: 4px;
            background: #333; border: 1px solid transparent; cursor: grab; font-size: 0.9em;
        }
        .asset-item:hover { background: #3e3e42; border-color: #555; }
        .asset-tag { 
            font-size: 0.7em; padding: 2px 4px; background: #555; color: #fff; 
            margin-right: 8px; border-radius: 3px; width: 35px; text-align: center;
        }

        /* --- Properties --- */
        .prop-section { padding: 10px; border-bottom: 1px solid #333; }
        .prop-row { display: flex; gap: 5px; margin-bottom: 8px; }
        .prop-col { flex: 1; }
        .prop-label { display: block; font-size: 0.75em; margin-bottom: 2px; color: #aaa; }
        .prop-input { width: 100%; background: var(--input-bg); border: 1px solid #555; color: white; padding: 5px; font-size: 0.9em; }
        
        /* --- UI Nodes --- */
        .ui-node {
            position: absolute; display: flex; justify-content: center; align-items: center;
            cursor: pointer; user-select: none; border: 1px solid rgba(255,255,255,0.15); overflow: hidden;
        }
        .ui-node.selected { outline: 2px solid var(--accent); z-index: 999; }
        .handle { width: 8px; height: 8px; background: var(--accent); position: absolute; bottom: 0; right: 0; cursor: se-resize; display: none; }
        .selected .handle { display: block; }
        
        .node-info { pointer-events: none; font-size: 10px; color: rgba(255,255,255,0.7); text-align: center; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; padding: 2px; }

        /* --- Modal/Overlay --- */
        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7);
            z-index: 2000; display: none; justify-content: center; align-items: center;
        }
        .modal { background: var(--panel-bg); width: 500px; padding: 20px; border: 1px solid #555; box-shadow: 0 10px 25px #000; }
        .modal h3 { margin-top:0; color:white; }

        /* --- Mobile --- */
        @media(max-width: 800px) {
            .main-container { flex-direction: column; }
            .sidebar-left { width: 100%; height: 100px; flex-direction: row; overflow-x: auto; }
            .sidebar-right { position: fixed; bottom: 0; width: 100%; height: 350px; transform: translateY(100%); transition: 0.3s; z-index: 1000; border-top: 2px solid var(--accent); }
            .sidebar-right.open { transform: translateY(0); }
            #ui-preview { transform: scale(0.6); transform-origin: top left; margin-bottom: 120px; }
            .toggle-btn { display: block !important; }
        }
        .toggle-btn { display: none; position: fixed; bottom: 15px; right: 15px; width: 50px; height: 50px; background: var(--accent); border-radius: 50%; color: white; font-size: 24px; text-align: center; line-height: 50px; box-shadow: 0 4px 10px #000; z-index: 1001; cursor: pointer; }
    </style>
</head>
<body>

<datalist id="mc-bindings">
    <option value="button.menu_exit">Êàª„Çã (menu_exit)</option>
    <option value="button.menu_ok">Ê±∫ÂÆö (menu_ok)</option>
    <option value="button.chat">„ÉÅ„É£„ÉÉ„Éà (chat)</option>
    <option value="button.slot_1">„Çπ„É≠„ÉÉ„Éà1</option>
</datalist>
<datalist id="mc-vis-bindings">
    <option value="visible_when_ui_hidden">HUDÈùûË°®Á§∫ÊôÇ„Å´Ë°®Á§∫</option>
    <option value="is_creative_mode">„ÇØ„É™„Ç®„Ç§„ÉÜ„Ç£„Éñ„É¢„Éº„ÉâÊôÇ</option>
    <option value="is_survival_mode">„Çµ„Éê„Ç§„Éê„É´„É¢„Éº„ÉâÊôÇ</option>
    <option value="has_item_in_hand">„Ç¢„Ç§„ÉÜ„É†ÊâÄÊåÅÊôÇ</option>
</datalist>

<header>
    <div class="brand">
        <span>MCBE UI Ultimate</span>
        <select id="presetSelect" class="dark-select" onchange="loadPreset(this.value)">
            <option value="" disabled selected>Select Template...</option>
            <option value="hud">HUD Screen (Play)</option>
            <option value="pause">Pause Screen</option>
            <option value="chat">Chat Screen</option>
            <option value="inventory">Inventory (Basic)</option>
            <option value="start">Start Screen</option>
        </select>
    </div>
    <div class="toolbar">
        <button class="btn" onclick="showUrlModal()">üåê URL Import</button>
        <button class="btn" onclick="document.getElementById('fileIn').click()">üìÇ Open</button>
        <button class="btn" onclick="document.getElementById('mergeIn').click()">‚ûï Merge</button>
        <button class="btn btn-primary" onclick="exportJson()">üíæ Export</button>
    </div>
    <input type="file" id="fileIn" hidden accept=".json">
    <input type="file" id="mergeIn" hidden accept=".json">
</header>

<div class="main-container">
    <div class="sidebar-left">
        <div class="panel-head">Element Palette</div>
        <div class="asset-list" id="assetList">
            <div class="asset-item" draggable="true" ondragstart="dragStart(event)" data-type="button">
                <div class="asset-tag">BTN</div> Button
            </div>
            <div class="asset-item" draggable="true" ondragstart="dragStart(event)" data-type="label">
                <div class="asset-tag">TXT</div> Label
            </div>
            <div class="asset-item" draggable="true" ondragstart="dragStart(event)" data-type="image">
                <div class="asset-tag">IMG</div> Image
            </div>
            <div class="asset-item" draggable="true" ondragstart="dragStart(event)" data-type="panel">
                <div class="asset-tag">PNL</div> Panel
            </div>
            <div class="asset-item" draggable="true" ondragstart="dragStart(event)" data-type="input">
                <div class="asset-tag">INP</div> Input
            </div>
        </div>
    </div>

    <div class="workspace" id="workspace" ondrop="drop(event)" ondragover="allowDrop(event)">
        <div id="ui-preview"></div>
    </div>

    <div class="sidebar-right" id="propPanel">
        <div class="panel-head" style="display:flex; justify-content:space-between;">
            Properties
            <span onclick="toggleProps()" style="cursor:pointer; font-weight:normal;">‚ñº</span>
        </div>
        
        <div id="global-settings" class="prop-section">
            <label class="prop-label">File Namespace</label>
            <input type="text" class="prop-input" id="globalNs" value="custom_ui">
        </div>

        <div id="element-props" style="display:none;">
            <div class="prop-section">
                <div class="prop-row">
                    <div class="prop-col">
                        <label class="prop-label">Key (ID) <span style="color:#d44">*</span></label>
                        <input type="text" class="prop-input" id="p-key" onchange="updateSelected()">
                    </div>
                </div>
                <div class="prop-row">
                    <div class="prop-col"><label class="prop-label">X</label><input type="number" class="prop-input" id="p-x" onchange="updateSelected()"></div>
                    <div class="prop-col"><label class="prop-label">Y</label><input type="number" class="prop-input" id="p-y" onchange="updateSelected()"></div>
                    <div class="prop-col"><label class="prop-label">W</label><input type="number" class="prop-input" id="p-w" onchange="updateSelected()"></div>
                    <div class="prop-col"><label class="prop-label">H</label><input type="number" class="prop-input" id="p-h" onchange="updateSelected()"></div>
                </div>
                <div class="prop-row">
                    <div class="prop-col">
                        <label class="prop-label">Anchor</label>
                        <select class="prop-input" id="p-anchor" onchange="updateSelected()">
                            <option value="top_left">Top Left</option>
                            <option value="top_right">Top Right</option>
                            <option value="bottom_left">Bottom Left</option>
                            <option value="bottom_right">Bottom Right</option>
                            <option value="center">Center</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="prop-section">
                <div class="prop-row">
                    <div class="prop-col">
                        <label class="prop-label">Text Content</label>
                        <input type="text" class="prop-input" id="p-text" onchange="updateSelected()">
                    </div>
                </div>
                <div class="prop-row">
                    <div class="prop-col">
                        <label class="prop-label">Texture Path</label>
                        <input type="text" class="prop-input" id="p-texture" placeholder="textures/ui/..." onchange="updateSelected()">
                    </div>
                </div>
            </div>

            <div class="prop-section">
                <div style="color:var(--accent); font-size:0.8em; margin-bottom:5px; font-weight:bold;">‚ö° Logic Triggers</div>
                
                <div class="prop-row">
                    <div class="prop-col">
                        <label class="prop-label">Button Action</label>
                        <input type="text" class="prop-input" id="p-binding" list="mc-bindings" placeholder="e.g. button.menu_exit" onchange="updateSelected()">
                    </div>
                </div>
            </div>

            <div class="prop-section" style="background:rgba(0,100,200,0.1);">
                <div style="color:var(--accent); font-size:0.8em; margin-bottom:5px; font-weight:bold;">üëÅÔ∏è Visibility</div>
                
                <div class="prop-row">
                    <div class="prop-col">
                        <label class="prop-label">Visibility Mode</label>
                        <select class="prop-input" id="p-vis-mode" onchange="updateVisInputs()">
                            <option value="always">Always Visible (Default)</option>
                            <option value="bound">Conditional (Bound)</option>
                            <option value="hidden">Hidden</option>
                        </select>
                    </div>
                </div>

                <div id="vis-binding-group" style="display:none;">
                    <div class="prop-row">
                        <div class="prop-col">
                            <label class="prop-label">Binding Name</label>
                            <input type="text" class="prop-input" id="p-vis-bind" list="mc-vis-bindings" placeholder="#is_creative" onchange="updateSelected()">
                        </div>
                    </div>
                    <div class="prop-row">
                        <div class="prop-col">
                            <label class="prop-label">Bind Type</label>
                            <select class="prop-input" id="p-vis-type" onchange="updateSelected()">
                                <option value="global">Global</option>
                                <option value="view">View</option>
                                <option value="collection">Collection</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="prop-section">
                <button class="btn" style="width:100%; background:var(--danger); border:none;" onclick="deleteSelected()">Delete Element</button>
            </div>
        </div>
        
        <div id="no-selection" style="padding:20px; text-align:center; color:#666;">
            Select an element to edit properties.
        </div>
    </div>
</div>

<div class="toggle-btn" onclick="toggleProps()">‚úèÔ∏è</div>

<div class="modal-overlay" id="urlModal" onclick="if(event.target===this) closeUrlModal()">
    <div class="modal">
        <h3>Import from URL</h3>
        <p style="font-size:0.9em; color:#aaa;">Paste a raw JSON URL (e.g. from GitHub raw content).</p>
        <input type="text" id="urlInput" class="prop-input" placeholder="https://raw.githubusercontent.com/..." style="margin-bottom:15px;">
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn" onclick="closeUrlModal()">Cancel</button>
            <button class="btn btn-primary" onclick="fetchFromUrl()">Load</button>
        </div>
    </div>
</div>

<script>
    // --- Data & State ---
    let appState = { namespace: "custom_ui", elements: [] };
    let selectedId = null;
    let uidCounter = 0;

    // --- References ---
    const canvas = document.getElementById('ui-preview');
    const globalNsInput = document.getElementById('globalNs');
    globalNsInput.addEventListener('input', (e) => appState.namespace = e.target.value);

    // --- GitHub Sample Presets (Simulated structures) ---
    // These mimic the official bedrock-samples structure logic
    const PRESETS = {
        hud: {
            ns: "hud_screen",
            elements: [
                { type: "image", key: "hotbar_bg", x: 227, y: 430, w: 400, h: 44, texture: "textures/ui/hotbar_bg", anchor: "bottom_middle" },
                { type: "image", key: "heart_renderer", x: 230, y: 400, w: 80, h: 9, texture: "textures/ui/heart_icon", anchor: "bottom_middle" },
                { type: "label", key: "xp_text", x: 410, y: 395, w: 40, h: 10, text: "7", color: "#80ff20", anchor: "bottom_middle", visMode: "bound", visBind: "#level_number_visible" }
            ]
        },
        pause: {
            ns: "pause_screen",
            elements: [
                { type: "panel", key: "bg_overlay", x: 0, y: 0, w: 854, h: 480, texture: "", color: "rgba(0,0,0,0.4)" },
                { type: "label", key: "pause_title", x: 377, y: 50, w: 100, h: 20, text: "Game Paused", anchor: "top_middle" },
                { type: "button", key: "resume_button", x: 302, y: 120, w: 250, h: 30, text: "Resume Game", binding: "button.menu_cancel", anchor: "center" },
                { type: "button", key: "settings_button", x: 302, y: 160, w: 250, h: 30, text: "Settings", anchor: "center" },
                { type: "button", key: "quit_button", x: 302, y: 200, w: 250, h: 30, text: "Save & Quit", binding: "button.menu_exit", anchor: "center" }
            ]
        },
        chat: {
            ns: "chat_screen",
            elements: [
                { type: "panel", key: "chat_bg", x: 0, y: 0, w: 854, h: 480, color: "rgba(0,0,0,0.2)" },
                { type: "input", key: "text_edit_box", x: 10, y: 440, w: 750, h: 30, text: "", texture: "textures/ui/edit_box_indent", anchor: "bottom_left" },
                { type: "button", key: "send_button", x: 770, y: 440, w: 70, h: 30, text: "Send", binding: "button.send", anchor: "bottom_right" }
            ]
        }
    };

    function loadPreset(key) {
        if(!PRESETS[key]) return;
        if(!confirm("Overwrite current workspace?")) return;
        
        const p = PRESETS[key];
        appState.namespace = p.ns;
        globalNsInput.value = p.ns;
        appState.elements = [];
        
        p.elements.forEach(el => {
            addControl(el.type, el.x, el.y, el.w, el.h, el);
        });
        renderAll();
    }

    // --- URL Import Functionality ---
    function showUrlModal() { document.getElementById('urlModal').style.display = 'flex'; }
    function closeUrlModal() { document.getElementById('urlModal').style.display = 'none'; }
    
    async function fetchFromUrl() {
        const url = document.getElementById('urlInput').value;
        if(!url) return;
        
        const btn = document.querySelector('#urlModal .btn-primary');
        const originalText = btn.innerText;
        btn.innerText = "Loading...";

        try {
            const res = await fetch(url);
            if(!res.ok) throw new Error("Status " + res.status);
            const json = await res.json();
            
            closeUrlModal();
            if(confirm("Merge into current (OK) or Replace (Cancel)?")) {
                mergeAssets(json, "Imported URL");
            } else {
                parseMainJson(json);
            }
        } catch(e) {
            alert("Failed to load: " + e.message + "\nNote: Some sites block direct access (CORS). Use Raw URLs.");
        } finally {
            btn.innerText = originalText;
        }
    }

    // --- Core Logic ---
    function addControl(type, x, y, w, h, props={}) {
        uidCounter++;
        const id = 'el_' + uidCounter;
        const newEl = {
            id: id,
            type: type,
            key: props.key || `${type}_${uidCounter}`,
            x: x, y: y, w: w || 50, h: h || 20,
            text: props.text || "",
            texture: props.texture || "",
            anchor: props.anchor || "top_left",
            binding: props.binding || "",
            // Visibility Logic
            visMode: props.visMode || "always", // always, bound, hidden
            visBind: props.visBind || "",
            visType: props.visType || "global"
        };
        appState.elements.push(newEl);
        return newEl;
    }

    // --- Drag and Drop Creation ---
    function allowDrop(ev) { ev.preventDefault(); }
    function dragStart(ev) {
        ev.dataTransfer.setData("type", ev.target.dataset.type);
    }
    function drop(ev) {
        ev.preventDefault();
        const type = ev.dataTransfer.getData("type");
        if(type) {
            const rect = canvas.getBoundingClientRect();
            // Scale correction
            const scale = canvas.offsetWidth / 854; // Approximation
            const x = (ev.clientX - rect.left); // Simplify for demo
            const y = (ev.clientY - rect.top);
            
            const el = addControl(type, x, y, type==='panel'?100:60, type==='panel'?100:30);
            renderAll();
            selectElement(el.id);
        }
    }

    // --- Rendering ---
    function renderAll() {
        canvas.innerHTML = '';
        appState.elements.forEach(data => {
            const el = document.createElement('div');
            el.className = 'ui-node';
            el.id = data.id;
            if(data.id === selectedId) el.classList.add('selected');

            // Style
            el.style.left = data.x + 'px';
            el.style.top = data.y + 'px';
            el.style.width = data.w + 'px';
            el.style.height = data.h + 'px';
            
            // Visual feedback for visibility
            if(data.visMode === 'hidden') {
                el.style.opacity = '0.3';
                el.style.borderStyle = 'dashed';
            } else if(data.visMode === 'bound') {
                el.style.border = '1px dotted var(--accent)';
            }

            // Content
            let content = data.text;
            if(!content && data.type === 'image') content = data.texture ? '' : 'IMG';
            el.innerHTML = `<span class="node-info">${content}</span><div class="handle"></div>`;
            
            if(data.texture) {
                el.style.backgroundImage = 'linear-gradient(135deg, #444 25%, transparent 25%), linear-gradient(225deg, #444 25%, transparent 25%), linear-gradient(45deg, #444 25%, transparent 25%), linear-gradient(315deg, #444 25%, transparent 25%)';
                el.style.backgroundSize = '10px 10px';
                el.style.backgroundColor = 'rgba(0,0,0,0.5)';
            } else if (data.type === 'panel') {
                el.style.backgroundColor = data.color || 'rgba(255,255,255,0.1)';
            } else if (data.type === 'button') {
                el.style.backgroundColor = '#666';
                el.style.border = '2px solid #222';
            }

            // Events
            el.onmousedown = (e) => { e.stopPropagation(); startInteract(e, data.id, e.target.classList.contains('handle')?'resize':'move'); };
            
            canvas.appendChild(el);
        });
    }

    // --- Interaction (Move/Resize) ---
    let interact = { active: false, id: null, type: '', sx:0, sy:0, init:{} };

    function startInteract(e, id, type) {
        selectElement(id);
        interact = { active:true, id:id, type:type, sx:e.clientX, sy:e.clientY, init:{...appState.elements.find(x=>x.id===id)} };
        document.addEventListener('mousemove', doInteract);
        document.addEventListener('mouseup', endInteract);
    }

    function doInteract(e) {
        if(!interact.active) return;
        const dx = e.clientX - interact.sx;
        const dy = e.clientY - interact.sy;
        const el = appState.elements.find(x=>x.id===interact.id);
        
        if(interact.type === 'move') {
            el.x = interact.init.x + dx;
            el.y = interact.init.y + dy;
        } else {
            el.w = Math.max(10, interact.init.w + dx);
            el.h = Math.max(10, interact.init.h + dy);
        }
        renderAll();
        populateProps(el);
    }

    function endInteract() {
        interact.active = false;
        document.removeEventListener('mousemove', doInteract);
        document.removeEventListener('mouseup', endInteract);
    }

    // --- Properties Logic ---
    function selectElement(id) {
        selectedId = id;
        renderAll(); // refresh selection border
        
        if(id) {
            document.getElementById('no-selection').style.display = 'none';
            document.getElementById('element-props').style.display = 'block';
            populateProps(appState.elements.find(e=>e.id===id));
            if(window.innerWidth < 800) document.getElementById('propPanel').classList.add('open');
        } else {
            document.getElementById('no-selection').style.display = 'block';
            document.getElementById('element-props').style.display = 'none';
        }
    }

    function populateProps(d) {
        if(!d) return;
        setVal('p-key', d.key);
        setVal('p-x', d.x); setVal('p-y', d.y);
        setVal('p-w', d.w); setVal('p-h', d.h);
        setVal('p-text', d.text);
        setVal('p-texture', d.texture);
        setVal('p-anchor', d.anchor);
        setVal('p-binding', d.binding);
        
        setVal('p-vis-mode', d.visMode);
        setVal('p-vis-bind', d.visBind);
        setVal('p-vis-type', d.visType);
        updateVisInputs();
    }

    function updateSelected() {
        if(!selectedId) return;
        const d = appState.elements.find(e=>e.id===selectedId);
        
        d.key = getVal('p-key');
        d.x = parseInt(getVal('p-x'))||0; d.y = parseInt(getVal('p-y'))||0;
        d.w = parseInt(getVal('p-w'))||10; d.h = parseInt(getVal('p-h'))||10;
        d.text = getVal('p-text');
        d.texture = getVal('p-texture');
        d.anchor = getVal('p-anchor');
        d.binding = getVal('p-binding');
        
        // Visibility
        d.visMode = getVal('p-vis-mode');
        d.visBind = getVal('p-vis-bind');
        d.visType = getVal('p-vis-type');

        renderAll();
    }

    function updateVisInputs() {
        const mode = document.getElementById('p-vis-mode').value;
        const group = document.getElementById('vis-binding-group');
        group.style.display = (mode === 'bound') ? 'block' : 'none';
    }

    function deleteSelected() {
        if(selectedId) {
            appState.elements = appState.elements.filter(e=>e.id!==selectedId);
            selectElement(null);
            renderAll();
        }
    }

    function setVal(id, v) { document.getElementById(id).value = v; }
    function getVal(id) { return document.getElementById(id).value; }
    function toggleProps() { document.getElementById('propPanel').classList.toggle('open'); }

    // --- File IO (Export) ---
    function exportJson() {
        const out = { namespace: appState.namespace };
        
        appState.elements.forEach(el => {
            const node = {
                type: el.type,
                offset: [el.x, el.y],
                size: [el.w, el.h],
                layer: 1
            };
            
            // Basic Props
            if(el.anchor !== "top_left") { node.anchor_from = el.anchor; node.anchor_to = el.anchor; }
            if(el.text) node.text = el.text;
            if(el.texture) node.texture = el.texture;
            
            // Logic: Bindings & Visibility
            let bindings = [];
            
            // Action Binding (Button press)
            if(el.binding) {
                bindings.push({ binding_type: "global", binding_name: el.binding });
            }

            // Visibility Logic
            if(el.visMode === 'hidden') {
                node.visible = false;
            } else if (el.visMode === 'bound' && el.visBind) {
                // MCBE Standard for visibility binding
                bindings.push({
                    binding_type: el.visType,
                    binding_name: el.visBind,
                    binding_name_override: "visible"
                });
            }

            if(bindings.length > 0) node.bindings = bindings;
            
            out[el.key] = node;
        });

        const blob = new Blob([JSON.stringify(out, null, 2)], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${appState.namespace}.json`;
        a.click();
    }

    // --- File IO (Import/Merge) ---
    document.getElementById('fileIn').addEventListener('change', (e) => loadFile(e.target.files[0], false));
    document.getElementById('mergeIn').addEventListener('change', (e) => loadFile(e.target.files[0], true));

    function loadFile(file, isMerge) {
        if(!file) return;
        const r = new FileReader();
        r.onload = e => {
            try { 
                const j = JSON.parse(e.target.result); 
                isMerge ? mergeAssets(j, file.name) : parseMainJson(j); 
            } catch(x){ alert("JSON Error"); }
        };
        r.readAsText(file);
    }

    function parseMainJson(json) {
        appState.elements = [];
        appState.namespace = json.namespace || "imported";
        globalNsInput.value = appState.namespace;
        
        for(let k in json) {
            if(k==='namespace') continue;
            const v = json[k];
            if(v.type) {
                // Extract Visibility
                let vMode = "always";
                let vBind = "";
                let vType = "global";
                
                if(v.visible === false) vMode = "hidden";
                if(v.bindings) {
                    const visB = v.bindings.find(b => b.binding_name_override === 'visible');
                    if(visB) {
                        vMode = "bound";
                        vBind = visB.binding_name;
                        vType = visB.binding_type || "global";
                    }
                }

                // Extract Action Binding
                let actBind = "";
                if(v.bindings) {
                    const ab = v.bindings.find(b => !b.binding_name_override);
                    if(ab) actBind = ab.binding_name;
                }

                addControl(v.type, v.offset?.[0]||0, v.offset?.[1]||0, v.size?.[0]||50, v.size?.[1]||20, {
                    key: k,
                    text: v.text,
                    texture: v.texture,
                    anchor: v.anchor_from,
                    binding: actBind,
                    visMode: vMode,
                    visBind: vBind,
                    visType: vType
                });
            }
        }
        renderAll();
    }

    function mergeAssets(json, fname) {
        const list = document.getElementById('assetList');
        const h = document.createElement('div');
        h.innerText = `File: ${fname}`; h.style.cssText="color:#888; font-size:0.8em; padding:5px;";
        list.appendChild(h);
        
        for(let k in json) {
            if(json[k].type) {
                const d = document.createElement('div');
                d.className = 'asset-item';
                d.innerHTML = `<span class="asset-tag">ADD</span> ${k}`;
                d.onclick = () => {
                    // Quick add copy
                    const v = json[k];
                    addControl(v.type, 50, 50, v.size?.[0]||100, v.size?.[1]||30, { key: k+"_copy", text: v.text, texture: v.texture });
                    renderAll();
                };
                list.appendChild(d);
            }
        }
    }
</script>
</body>
</html>
